<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tiara Liz Thomas ‚Äî Holy Communion RSVP</title>

  <!-- Elegant fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070a12;
      --text:#eef2ff;
      --muted: rgba(238,242,255,.72);
      --gold:#d9b65b;
      --gold2:#f3e3b2;

      --cardA: rgba(255,255,255,.07);
      --cardB: rgba(255,255,255,.03);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(217,182,91,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(125,211,252,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding:18px;
      display:flex;
      justify-content:center;
    }
    .wrap{width:min(980px, 100%); position:relative; isolation:isolate;}

    /* Botanical overlays */
    .wrap::before,
    .wrap::after{
      content:"";
      position:fixed;
      width:300px;
      height:300px;
      background-repeat:no-repeat;
      background-size:contain;
      pointer-events:none;
      z-index:-1;
      opacity:.85;
      filter: blur(.2px);
    }
    .wrap::before{
      top:-60px; left:-70px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 260 260'%3E%3Cg fill='none' stroke='%237daa8c' stroke-opacity='.55' stroke-width='2'%3E%3Cpath d='M40 190c35-85 120-135 200-140-18 95-75 170-170 205'/%3E%3Cpath d='M70 205c24-60 78-105 148-125'/%3E%3Cpath d='M95 185c18-45 55-78 108-95'/%3E%3C/g%3E%3C/svg%3E");
    }
    .wrap::after{
      bottom:-70px; right:-70px;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 260 260'%3E%3Cg fill='none' stroke='%23d9b65b' stroke-opacity='.55' stroke-width='1.8'%3E%3Ccircle cx='150' cy='130' r='22'/%3E%3Cpath d='M150 82c6-18 20-30 40-34-6 20-18 34-38 42'/%3E%3Cpath d='M150 178c-6 18-20 30-40 34 6-20 18-34 38-42'/%3E%3Cpath d='M122 130c-18-6-30-20-34-40 20 6 34 18 42 38'/%3E%3Cpath d='M178 130c18 6 30 20 34 40-20-6-34-18-42-38'/%3E%3Cpath d='M110 92l-20-20M190 168l20 20M110 168l-20 20M190 92l20-20'/%3E%3C/g%3E%3C/svg%3E");
    }

    /* Header */
    .hero{
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 26px 80px rgba(0,0,0,.42);
      background: rgba(255,255,255,.04);
      position:relative;
      margin-bottom:14px;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-70px -90px auto -90px;
      height:240px;
      background:
        radial-gradient(260px 160px at 25% 45%, rgba(125,170,140,.18), transparent 60%),
        radial-gradient(240px 160px at 75% 35%, rgba(217,182,91,.18), transparent 62%),
        radial-gradient(320px 220px at 55% 0%, rgba(125,170,140,.10), transparent 62%);
      pointer-events:none;
    }
    .hero-inner{
      position:relative;
      padding: 16px 16px;
      display:grid;
      gap:10px;
      z-index:1;
    }
    .badge{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 12px;
      border-radius:999px;
      width:fit-content;
      border:1px solid rgba(217,182,91,.35);
      background: rgba(217,182,91,.08);
      color: var(--gold2);
      font-weight:700;
      font-size:13px;
      letter-spacing:.2px;
    }
    .h-title{
      margin:8px 0 2px;
      font-family:"Playfair Display", serif;
      font-size: clamp(28px, 7.2vw, 48px);
      line-height:1.05;
      text-shadow: 0 8px 28px rgba(0,0,0,.42);
    }
    .h-sub{
      margin:0;
      color: var(--muted);
      font-size:14px;
      line-height:1.6;
    }
    .gold-divider{
      width:86px; height:3px; border-radius:999px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
      margin-top:8px;
    }

    /* Flip container */
    .flip-wrap{ perspective: 1200px; }
    .flip{
      position:relative;
      width:100%;
      min-height: 560px;
      transform-style: preserve-3d;
      transition: transform .7s cubic-bezier(.2,.8,.2,1);
    }
    .flip.is-flipped{ transform: rotateY(180deg); }

    .face{
      position:absolute;
      inset:0;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
      overflow:hidden;

      /* iOS/Safari reliability */
      -webkit-backface-visibility:hidden;
      backface-visibility:hidden;
      transform: translateZ(0);
    }
    .face.back{ transform: rotateY(180deg) translateZ(0); }

    .head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{
      font-family:"Playfair Display", serif;
      font-size:18px;
      font-weight:700;
    }
    .pill{
      font-size:12px;
      border:1px solid rgba(217,182,91,.35);
      background: rgba(217,182,91,.08);
      color: var(--gold2);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
      font-weight:800;
    }
    .content{ padding:14px 16px; }

    /* FRONT */
    .program{ display:grid; gap:12px; }

    /* Make the front card clearly tappable */
    .frontTap{
      cursor:pointer;
      user-select:none;
    }
    .frontTap:active{ transform: scale(.998); }

    .rowbox{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .k{ min-width:110px; color: var(--muted); font-size:13px }
    .v{ font-size:14px; line-height:1.55 }

    .eventlist{ display:grid; gap:10px; margin-top:2px; }
    .eventitem{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .eleft{display:grid; gap:6px; max-width: 70ch;}
    .ename{font-weight:900}
    .eline{color: rgba(238,242,255,.82); font-size:13px}
    .addr{color: rgba(238,242,255,.78); font-size:13px; line-height:1.45}
    .actionsRight{display:flex; gap:8px; align-items:center; flex:0 0 auto;}

    .ico{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      color: var(--text);
      font-size:16px;
      line-height:1;
    }
    .ico:hover{filter:brightness(1.08)}
    .ico.gold{
      border-color: rgba(217,182,91,.35);
      background: rgba(217,182,91,.10);
      color: var(--gold2);
    }

    .hint{ margin-top:10px; color: var(--muted); font-size:12px; }

    /* Success banner on FRONT */
    .toast{
      display:none;
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(125,211,252,.30);
      background: rgba(125,211,252,.08);
      color: var(--text);
      font-size:14px;
    }
    .toast strong{ color: var(--gold2); }

    /* BACK (RSVP form) */
    form{ display:grid; gap:12px; }
    label{ display:grid; gap:6px; font-size:13px; color: var(--muted); }
    input, select{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-size:16px;
    }
    input:focus, select:focus{
      border-color: rgba(217,182,91,.55);
      box-shadow: 0 0 0 4px rgba(217,182,91,.10);
    }
    input:disabled{ opacity:.55; cursor:not-allowed; }

    .two{ display:grid; grid-template-columns:1fr; gap:12px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px; }
    .btn{
      cursor:pointer;
      border:0;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      flex:1 1 160px;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(217,182,91,1), rgba(217,182,91,.88));
      color:#1a1406;
    }
    .btn.ghost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
    }
    .note{ font-size:12px; color: var(--muted); margin:4px 0 0; }

    .toast.err{
      display:none;
      border-color: rgba(251,113,133,.45);
      background: rgba(251,113,133,.08);
    }

    footer{ margin:14px 0 0; text-align:center; color: rgba(169,179,199,.8); font-size:12px; }

    @media (min-width: 920px){
      body{ padding:22px; }
      .hero-inner{ padding: 20px 22px; }
      .flip{ min-height: 470px; }
      .two{ grid-template-columns: 1fr 1fr; }
    }
    @media (prefers-reduced-motion: reduce){
      .flip{ transition: none; }
    }
  </style>
</head>

<body>
  <div class="wrap">

    <section class="hero">
      <div class="hero-inner">
        <div class="badge">‚ú¶ First Holy Communion</div>
        <h1 class="h-title">Tiara Liz Thomas</h1>
        <p class="h-sub">Monday, 06 April 2026 ‚Ä¢ A day of faith, grace, and celebration.</p>
        <div class="gold-divider"></div>
      </div>
    </section>

    <div class="flip-wrap" id="flipWrap">
      <div class="flip" id="flipCard" aria-live="polite">

        <!-- FRONT: Details (whole card tappable) -->
        <section class="face front frontTap" id="frontFace" role="button" tabindex="0" aria-label="Tap to open RSVP">
          <div class="head">
            <div class="title">Program & Details</div>
            <div class="pill">Tap anywhere to RSVP</div>
          </div>

          <div class="content">
            <div class="program">
              <div class="rowbox">
                <div class="k">Date</div>
                <div class="v">Monday, 06 April 2026</div>
              </div>

              <div class="rowbox">
                <div class="k">Program</div>
                <div class="v" style="width:100%">
                  <div class="eventlist">

                    <div class="eventitem">
                      <div class="eleft">
                        <div class="ename">Holy Mass</div>
                        <div class="eline"><b>3:00 PM</b> at Saint Michael's Catholic Church</div>
                        <div class="addr">129 High St, Berwick VIC 3806</div>
                      </div>
                      <div class="actionsRight">
                        <a class="ico stopTap" target="_blank" rel="noopener" title="Open in Google Maps"
                           href="https://www.google.com/maps/search/?api=1&query=Saint%20Michael%27s%20Catholic%20Church%2C%20129%20High%20St%2C%20Berwick%20VIC%203806">üìç</a>
                        <a class="ico gold stopTap" id="gcalMass" target="_blank" rel="noopener" title="Add to Google Calendar">G</a>
                        <button class="ico stopTap" id="icsMass" type="button" title="Add to Apple Calendar (.ics)">Ô£ø</button>
                      </div>
                    </div>

                    <div class="eventitem">
                      <div class="eleft">
                        <div class="ename">Reception</div>
                        <div class="eline"><b>6:30 PM</b> at Golden Castle Function Centre</div>
                        <div class="addr">Hampton Park, Victoria</div>
                      </div>
                      <div class="actionsRight">
                        <a class="ico stopTap" target="_blank" rel="noopener" title="Open in Google Maps"
                           href="https://www.google.com/maps/search/?api=1&query=Golden%20Castle%20Function%20Centre%2C%20Hampton%20Park%2C%20Victoria">üìç</a>
                        <a class="ico gold stopTap" id="gcalReception" target="_blank" rel="noopener" title="Add to Google Calendar">G</a>
                        <button class="ico stopTap" id="icsReception" type="button" title="Add to Apple Calendar (.ics)">Ô£ø</button>
                      </div>
                    </div>

                  </div>

                  <div class="hint">Tip: Tap üìç for directions, <b>G</b> for Google Calendar, or <b>Ô£ø</b> to download an Apple Calendar file.</div>
                </div>
              </div>

              <!-- Success message shown AFTER RSVP and also when user comes back later -->
              <div class="toast" id="successToast">‚úÖ <span id="successText"></span></div>

              <div class="hint">After RSVP, your confirmation will stay visible here.</div>
            </div>
          </div>
        </section>

        <!-- BACK: RSVP form -->
        <section class="face back" id="backFace">
          <div class="head">
            <div class="title">RSVP</div>
            <button class="btn ghost stopTap" id="backBtn" type="button" style="flex:0 0 auto; padding:10px 12px; border-radius:14px;">
              Back
            </button>
          </div>

          <div class="content">
            <form id="rsvpForm" novalidate>
              <label>
                Family Name / Your Name *
                <input name="familyName" required placeholder="e.g., Thomas" />
              </label>

              <label>
                Attending? *
                <select name="attending" id="attending" required>
                  <option value="" selected disabled>Select‚Ä¶</option>
                  <option>Yes</option>
                  <option>No</option>
                </select>
              </label>

              <div class="two">
                <label>
                  Number of Adults attending *
                  <input type="number" id="adults" name="adults" min="0" required value="0" />
                </label>

                <label>
                  Number of Kids (Below 14)
                  <input type="number" id="kids" name="kids" min="0" value="0" />
                </label>
              </div>

              <div class="actions">
                <button class="btn primary" type="submit" id="submitBtn">Submit RSVP</button>
                <button class="btn ghost" type="button" id="resetBtn">Clear</button>
              </div>

              <p class="note">Your RSVP will be recorded to our Google Sheet.</p>

              <div class="toast err" id="errToast">‚ùå Sorry ‚Äî something went wrong. Please try again.</div>

              <!-- Persisted confirmation shown on RSVP page if already submitted -->
              <div class="toast" id="rsvpConfirm" style="display:none; border-color: rgba(217,182,91,.35); background: rgba(217,182,91,.10);">
                ‚úÖ <span id="rsvpConfirmText"></span>
              </div>

              <div class="hint">If you have already RSVPed, your confirmation will show here.</div>
            </form>
          </div>
        </section>

      </div>
    </div>

    <footer>Tip: share this RSVP page link on WhatsApp / SMS / email.</footer>
  </div>

  <script>
    // -----------------------
    // Flip controls
    // -----------------------
    const flipCard = document.getElementById("flipCard");
    const frontFace = document.getElementById("frontFace");
    const backBtn = document.getElementById("backBtn");
    const flipWrap = document.getElementById("flipWrap");

    function flipToRsvp() {
      flipCard.classList.add("is-flipped");
      flipWrap.scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => document.querySelector("input[name='familyName']")?.focus(), 350);
      showPersistedConfirmation(); // show message on RSVP side if already submitted
    }
    function flipToDetails() {
      flipCard.classList.remove("is-flipped");
      flipWrap.scrollIntoView({ behavior: "smooth", block: "start" });
      // Ensure toast is visible after flip back
      setTimeout(() => document.getElementById("successToast")?.scrollIntoView({behavior:"smooth", block:"nearest"}), 250);
    }

    // Make whole front card tappable, but NOT the icons/links/buttons
    frontFace.addEventListener("click", (e) => {
      if (e.target.closest(".stopTap")) return;
      flipToRsvp();
    });
    frontFace.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        flipToRsvp();
      }
    });

    backBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      flipToDetails();
    });

    // Prevent icon clicks bubbling (so they don't flip the card)
    document.querySelectorAll(".stopTap").forEach(el => {
      el.addEventListener("click", (e) => e.stopPropagation());
    });

    // -----------------------
    // RSVP -> Google Form POST
    // -----------------------
    const FORM_ACTION =
      "https://docs.google.com/forms/d/e/1FAIpQLSf26EDBCCSbnyzG39YNCY3YQ8btg2r1uUcti29MCU94SLxaJA/formResponse";

    const ENTRY_MAP = {
      familyName: "entry.169108837",
      attending:  "entry.1331553265",
      adults:     "entry.944248803",
      kids:       "entry.1620308496"
    };

    const form = document.getElementById("rsvpForm");
    const resetBtn = document.getElementById("resetBtn");
    const submitBtn = document.getElementById("submitBtn");

    const attendingSelect = document.getElementById("attending");
    const adultsInput = document.getElementById("adults");
    const kidsInput = document.getElementById("kids");

    const successToast = document.getElementById("successToast");
    const successText = document.getElementById("successText");
    const errToast = document.getElementById("errToast");

    const rsvpConfirm = document.getElementById("rsvpConfirm");
    const rsvpConfirmText = document.getElementById("rsvpConfirmText");

    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }

    function updateAttendanceRules() {
      const attending = attendingSelect.value;

      if (attending === "Yes") {
        adultsInput.disabled = false;
        kidsInput.disabled = false;

        adultsInput.min = 1;
        adultsInput.required = true;

        if (parseInt(adultsInput.value || "0", 10) < 1) adultsInput.value = 1;

      } else if (attending === "No") {
        adultsInput.value = 0;
        kidsInput.value = 0;

        adultsInput.disabled = true;
        kidsInput.disabled = true;

        adultsInput.required = false;
        adultsInput.min = 0;

      } else {
        adultsInput.disabled = false;
        kidsInput.disabled = false;
        adultsInput.min = 0;
        adultsInput.required = true;
      }
    }

    attendingSelect.addEventListener("change", updateAttendanceRules);
    updateAttendanceRules();

    // ---- Persisted confirmation handling (localStorage)
    const STORAGE_KEY = "tiara_holy_communion_rsvp_confirmation_v1";

    function saveConfirmation(summaryTextPlain, summaryHtml) {
      const payload = {
        plain: summaryTextPlain,
        html: summaryHtml,
        ts: Date.now()
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }

    function loadConfirmation() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch { return null; }
    }

    function showPersistedConfirmation() {
      const conf = loadConfirmation();
      if (!conf) {
        hide(rsvpConfirm);
        return;
      }
      rsvpConfirmText.innerHTML = conf.html || conf.plain;
      show(rsvpConfirm);
    }

    function showConfirmationOnDetails() {
      const conf = loadConfirmation();
      if (!conf) return;
      successText.innerHTML = conf.html || conf.plain;
      show(successToast);
    }

    // Show confirmation on load (details side)
    showConfirmationOnDetails();

    resetBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      form.reset();
      hide(errToast);
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit RSVP";
      updateAttendanceRules();
      showPersistedConfirmation();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(errToast);

      // Rule: If Yes, adults must be >= 1
      if (attendingSelect.value === "Yes" && parseInt(adultsInput.value || "0", 10) < 1) {
        adultsInput.focus();
        adultsInput.setCustomValidity("Please enter at least 1 adult.");
        adultsInput.reportValidity();
        adultsInput.setCustomValidity("");
        return;
      }

      // If No, force 0s
      if (attendingSelect.value === "No") {
        adultsInput.value = 0;
        kidsInput.value = 0;
      }

      const data = Object.fromEntries(new FormData(form).entries());
      const attending = (data.attending || "").trim();
      const adults = parseInt(data.adults || "0", 10);
      const kids = parseInt(data.kids || "0", 10);
      const who = (data.familyName || "").trim();

      // Build confirmation summary
      let summaryHtml = "";
      let summaryPlain = "";

      if (attending === "No") {
        summaryHtml = `Thanks${who ? " " + who : ""}! We‚Äôve received your RSVP ‚Äî <strong>not attending</strong>.`;
        summaryPlain = `Thanks${who ? " " + who : ""}! We‚Äôve received your RSVP ‚Äî not attending.`;
      } else {
        summaryHtml = `Thanks${who ? " " + who : ""}! RSVP received for <strong>${adults} Adult${adults===1?"":"s"}</strong> and <strong>${kids} Kid${kids===1?"":"s"}</strong>.`;
        summaryPlain = `Thanks${who ? " " + who : ""}! RSVP received for ${adults} Adult${adults===1?"":"s"} and ${kids} Kid${kids===1?"":"s"}.`;
      }

      // Save locally so if user opens RSVP again, they see it
      saveConfirmation(summaryPlain, summaryHtml);

      // Prepare Google Form payload
      const fd = new FormData();
      for (const [name, entryId] of Object.entries(ENTRY_MAP)) {
        fd.append(entryId, data[name] ?? "");
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting‚Ä¶";

      try {
        await fetch(FORM_ACTION, { method: "POST", mode: "no-cors", body: fd });

        // Reset form fields (optional) but keep confirmation persisted
        form.reset();
        updateAttendanceRules();
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit RSVP";

        // Show confirmation on BOTH sides
        successText.innerHTML = summaryHtml;
        show(successToast);

        rsvpConfirmText.innerHTML = summaryHtml;
        show(rsvpConfirm);

        // Flip back to details
        flipToDetails();

      } catch (err) {
        show(errToast);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit RSVP";
      }
    });

    // -----------------------
    // Add to Calendar (Google + Apple/ICS)
    // -----------------------
    const EVENT_YEAR = 2026;
    const EVENT_TZ = "Australia/Melbourne";

    const MASS = {
      title: "Holy Mass ‚Äî Tiara Liz Thomas First Holy Communion",
      location: "Saint Michael's Catholic Church, 129 High St, Berwick VIC 3806",
      description: "First Holy Communion of Tiara Liz Thomas.",
      start: { y: EVENT_YEAR, m: 4, d: 6, hh: 15, mm: 0 },
      end:   { y: EVENT_YEAR, m: 4, d: 6, hh: 16, mm: 0 }
    };

    const RECEPTION = {
      title: "Reception ‚Äî Tiara Liz Thomas First Holy Communion",
      location: "Golden Castle Function Centre, Hampton Park, Victoria",
      description: "Reception for Tiara Liz Thomas First Holy Communion.",
      start: { y: EVENT_YEAR, m: 4, d: 6, hh: 18, mm: 30 },
      end:   { y: EVENT_YEAR, m: 4, d: 6, hh: 22, mm: 30 }
    };

    function toUtcIcs(dt) {
      const local = new Date(dt.y, dt.m - 1, dt.d, dt.hh, dt.mm, 0);
      const yyyy = local.getUTCFullYear();
      const MM = String(local.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(local.getUTCDate()).padStart(2, "0");
      const HH = String(local.getUTCHours()).padStart(2, "0");
      const mm = String(local.getUTCMinutes()).padStart(2, "0");
      return `${yyyy}${MM}${dd}T${HH}${mm}00Z`;
    }

    function googleDateRange(start, end) {
      return `${toUtcIcs(start)}/${toUtcIcs(end)}`;
    }

    function buildGoogleUrl(ev) {
      const params = new URLSearchParams({
        action: "TEMPLATE",
        text: ev.title,
        dates: googleDateRange(ev.start, ev.end),
        details: ev.description,
        location: ev.location,
        ctz: EVENT_TZ
      });
      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    function escapeIcsText(s) {
      return String(s || "")
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function buildIcs(ev) {
      const uid = `tiara-communion-${Math.random().toString(16).slice(2)}@githubpages`;
      const now = new Date();
      const dtstamp =
        `${now.getUTCFullYear()}${String(now.getUTCMonth()+1).padStart(2,"0")}${String(now.getUTCDate()).padStart(2,"0")}` +
        `T${String(now.getUTCHours()).padStart(2,"0")}${String(now.getUTCMinutes()).padStart(2,"0")}00Z`;

      return [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Tiara Holy Communion//RSVP//EN",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH",
        "BEGIN:VEVENT",
        `UID:${uid}`,
        `DTSTAMP:${dtstamp}`,
        `DTSTART:${toUtcIcs(ev.start)}`,
        `DTEND:${toUtcIcs(ev.end)}`,
        `SUMMARY:${escapeIcsText(ev.title)}`,
        `DESCRIPTION:${escapeIcsText(ev.description)}`,
        `LOCATION:${escapeIcsText(ev.location)}`,
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");
    }

    function downloadIcs(ev, filename) {
      const ics = buildIcs(ev);
      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // Wire up calendar icons
    const gcalMass = document.getElementById("gcalMass");
    const gcalReception = document.getElementById("gcalReception");
    const icsMass = document.getElementById("icsMass");
    const icsReception = document.getElementById("icsReception");

    gcalMass.href = buildGoogleUrl(MASS);
    gcalReception.href = buildGoogleUrl(RECEPTION);

    icsMass.addEventListener("click", (e) => { e.stopPropagation(); downloadIcs(MASS, "Tiara-Holy-Mass.ics"); });
    icsReception.addEventListener("click", (e) => { e.stopPropagation(); downloadIcs(RECEPTION, "Tiara-Reception.ics"); });
  </script>
</body>
</html>
