<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tiara Liz Thomas ‚Äî Holy Communion RSVP</title>

  <!-- Elegant fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Dark luxe theme */
      --bg:#070a12;
      --text:#eef2ff;
      --muted: rgba(238,242,255,.72);
      --stroke: rgba(255,255,255,.12);
      --gold:#d9b65b;
      --gold2:#f3e3b2;
      --accent:#7dd3fc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(217,182,91,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(125,211,252,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
      padding:18px;
      display:flex;
      justify-content:center;
    }
    .wrap{width:min(1040px, 100%); position:relative; isolation:isolate;}

    /* Botanical overlays */
    .wrap::before,
    .wrap::after{
      content:"";
      position:fixed;
      width:320px;
      height:320px;
      background-repeat:no-repeat;
      background-size:contain;
      pointer-events:none;
      z-index:-1;
      opacity:.85;
      filter: blur(.2px);
    }
    .wrap::before{
      top:-60px;
      left:-70px;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 260 260'%3E%3Cg fill='none' stroke='%237daa8c' stroke-opacity='.55' stroke-width='2'%3E%3Cpath d='M40 190c35-85 120-135 200-140-18 95-75 170-170 205'/%3E%3Cpath d='M70 205c24-60 78-105 148-125'/%3E%3Cpath d='M95 185c18-45 55-78 108-95'/%3E%3C/g%3E%3C/svg%3E");
    }
    .wrap::after{
      bottom:-70px;
      right:-70px;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 260 260'%3E%3Cg fill='none' stroke='%23d9b65b' stroke-opacity='.55' stroke-width='1.8'%3E%3Ccircle cx='150' cy='130' r='22'/%3E%3Cpath d='M150 82c6-18 20-30 40-34-6 20-18 34-38 42'/%3E%3Cpath d='M150 178c-6 18-20 30-40 34 6-20 18-34 38-42'/%3E%3Cpath d='M122 130c-18-6-30-20-34-40 20 6 34 18 42 38'/%3E%3Cpath d='M178 130c18 6 30 20 34 40-20-6-34-18-42-38'/%3E%3Cpath d='M110 92l-20-20M190 168l20 20M110 168l-20 20M190 92l20-20'/%3E%3C/g%3E%3C/svg%3E");
    }

    /* HERO */
    .hero{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 90px rgba(0,0,0,.45);
      margin-bottom:16px;
      background: rgba(255,255,255,.04);
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520' viewBox='0 0 520 520'%3E%3Cg fill='none' stroke='%23f3e3b2' stroke-opacity='.15'%3E%3Cpath d='M78 110c40 10 70 44 80 90-46-10-80-40-90-80z'/%3E%3Cpath d='M160 86c20 34 20 78-2 118-34-20-52-58-46-96z'/%3E%3Cpath d='M420 420c-44-10-78-44-88-92 48 12 82 44 92 88z'/%3E%3Ccircle cx='260' cy='260' r='86'/%3E%3Cpath d='M260 174c18 24 18 56 0 80-18-24-18-56 0-80z'/%3E%3Cpath d='M174 260c24-18 56-18 80 0-24 18-56 18-80 0z'/%3E%3Cpath d='M260 346c-18-24-18-56 0-80 18 24 18 56 0 80z'/%3E%3Cpath d='M346 260c-24 18-56 18-80 0 24-18 56-18 80 0z'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 520px 520px;
      opacity:.45;
      pointer-events:none;
      mix-blend-mode: overlay;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-60px -80px auto -80px;
      height:240px;
      background:
        radial-gradient(260px 160px at 25% 40%, rgba(125,170,140,.18), transparent 60%),
        radial-gradient(240px 160px at 75% 35%, rgba(217,182,91,.18), transparent 62%),
        radial-gradient(320px 220px at 55% 0%, rgba(125,170,140,.10), transparent 62%);
      pointer-events:none;
    }

    .hero-inner{
      position:relative;
      padding: 18px 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      z-index:1;
    }

    .badge{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 12px;
      border-radius:999px;
      width:fit-content;
      border:1px solid rgba(217,182,91,.35);
      background: rgba(217,182,91,.08);
      color: var(--gold2);
      font-weight:700;
      font-size:13px;
      letter-spacing:.2px;
    }
    .h-title{
      margin:10px 0 6px;
      font-family: "Playfair Display", serif;
      font-size: clamp(30px, 8vw, 52px);
      line-height:1.05;
      text-shadow: 0 8px 30px rgba(0,0,0,.45);
    }
    .h-sub{
      margin:0;
      color: var(--muted);
      font-size:15px;
      line-height:1.6;
      max-width: 62ch;
    }
    .gold-divider{
      margin-top:12px;
      width:90px;
      height:3px;
      border-radius:999px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    .hero-card{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      padding:14px;
      backdrop-filter: blur(6px);
    }
    .hero-card h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.25px;
      color: rgba(238,242,255,.78);
      font-weight:800;
      text-transform:uppercase;
    }
    .timeline{display:grid; gap:10px}
    .titem{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--gold);
      margin-top:6px;
      box-shadow: 0 0 0 4px rgba(217,182,91,.12);
      flex:0 0 auto;
    }
    .tname{font-weight:900}
    .ttime{color: rgba(238,242,255,.75); font-size:13px; margin-top:2px}

    /* MAIN GRID */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    /* cards */
    .card{
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .head{
      padding:16px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{
      font-family:"Playfair Display", serif;
      font-size:18px;
      font-weight:700;
    }
    .pill{
      font-size:12px;
      border:1px solid rgba(217,182,91,.35);
      background: rgba(217,182,91,.08);
      color: var(--gold2);
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
      font-weight:800;
    }
    .content{padding:16px}

    /* form */
    form{display:grid; gap:12px}
    label{display:grid; gap:6px; font-size:13px; color: var(--muted)}
    input, select{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
      font-size:16px;
      transition: opacity .15s ease, filter .15s ease, box-shadow .15s ease;
    }
    input:focus, select:focus{
      border-color: rgba(217,182,91,.55);
      box-shadow: 0 0 0 4px rgba(217,182,91,.10);
    }
    input:disabled{
      opacity:.55;
      filter:saturate(.7);
      cursor:not-allowed;
    }

    .two{display:grid; grid-template-columns:1fr; gap:12px}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      position: sticky; bottom: 10px;
      background: linear-gradient(180deg, rgba(7,10,18,0), rgba(7,10,18,.85));
      padding-top: 10px;
      margin-top: 6px;
    }
    button{
      cursor:pointer;
      border:0;
      border-radius:16px;
      padding:14px 14px;
      font-weight:900;
      font-size:15px;
      width:100%;
    }
    .btn{
      background: linear-gradient(180deg, rgba(217,182,91,1), rgba(217,182,91,.88));
      color:#1a1406;
    }
    .ghost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border:1px solid rgba(255,255,255,.14);
    }

    .note{font-size:12px; color: var(--muted); margin:8px 0 0}

    /* RSVP result card shown after submit */
    .result{
      display:none;
      margin-top:12px;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:14px;
    }
    .result strong{color: var(--gold2)}
    .result-actions{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .tiny-ico{
      width:36px;
      height:36px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      font-size:16px;
      line-height:1;
    }
    .tiny-ico.gold{
      border-color: rgba(217,182,91,.35);
      background: rgba(217,182,91,.10);
      color: var(--gold2);
    }
    .tiny-text{
      color: var(--muted);
      font-size:12px;
    }

    /* info */
    .info{display:grid; gap:12px; padding:16px}
    .row{
      display:flex; gap:12px; align-items:flex-start;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background: rgba(0,0,0,.14);
      flex-wrap:wrap;
    }
    .k{min-width:110px; color: var(--muted); font-size:13px}
    .v{font-size:14px; line-height:1.5}

    .mapbtn{
      display:inline-block;
      margin-top:8px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
    }

    /* Small calendar icons (Event Details) */
    .times-wrap{display:grid; gap:10px; width:100%;}
    .time-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      border-radius:14px;
      padding:10px 10px;
    }
    .time-left{display:flex; flex-direction:column; gap:2px}
    .time-title{font-weight:900}
    .time-when{color: rgba(238,242,255,.78); font-size:13px}

    .cal-icons{
      display:flex;
      align-items:center;
      gap:8px;
      flex:0 0 auto;
    }
    .cal-ico{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      color: var(--text);
      font-size:16px;
      line-height:1;
    }
    .cal-ico:hover{filter:brightness(1.08)}
    .cal-ico.gold{
      border-color: rgba(217,182,91,.35);
      background: rgba(217,182,91,.10);
      color: var(--gold2);
    }
    .cal-help{
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
    }

    footer{margin:14px 0 0; text-align:center; color: rgba(169,179,199,.8); font-size:12px}

    /* Desktop layout */
    @media (min-width: 920px){
      body{padding:22px}
      .hero-inner{
        grid-template-columns: 1.1fr .9fr;
        padding: 26px 22px;
        align-items:end;
      }
      .grid{grid-template-columns: 1.2fr .8fr}
      .content{padding:16px 18px}
      .head{padding:16px 18px}
      .two{grid-template-columns:1fr 1fr}
      .actions{position:static; background:none; padding-top:0}
      button{width:auto}
      .btn{flex:1}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- HERO -->
    <section class="hero">
      <div class="hero-inner">
        <div>
          <div class="badge">‚ú¶ First Holy Communion</div>
          <h1 class="h-title">Tiara Liz Thomas</h1>
          <p class="h-sub">April 06 ‚Ä¢ A day of faith, grace, and celebration. Please RSVP below.</p>
          <div class="gold-divider"></div>
        </div>

        <div class="hero-card">
          <h3>Program</h3>
          <div class="timeline">
            <div class="titem">
              <div class="dot"></div>
              <div>
                <div class="tname">Holy Mass</div>
                <div class="ttime">3:00 PM</div>
              </div>
            </div>
            <div class="titem">
              <div class="dot"></div>
              <div>
                <div class="tname">Reception</div>
                <div class="ttime">6:30 PM</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- RSVP FORM -->
      <div class="card" id="rsvpCard">
        <div class="head">
          <div class="title">RSVP</div>
          <div class="pill">Saved to Google Sheet</div>
        </div>

        <div class="content">
          <form id="rsvpForm" novalidate>
            <label>
              Family Name / Your Name *
              <input name="familyName" required placeholder="e.g., Thomas" />
            </label>

            <label>
              Attending? *
              <select name="attending" id="attending" required>
                <option value="" selected disabled>Select‚Ä¶</option>
                <option>Yes</option>
                <option>No</option>
              </select>
            </label>

            <div class="two">
              <label>
                Number of Adults attending *
                <input type="number" id="adults" name="adults" min="0" required value="0" />
              </label>

              <label>
                Number of Kids (Below 14)
                <input type="number" id="kids" name="kids" min="0" value="0" />
              </label>
            </div>

            <div class="actions">
              <button class="btn" type="submit" id="submitBtn">Submit RSVP</button>
              <button class="ghost" type="button" id="resetBtn">Clear</button>
            </div>

            <p class="note">Your RSVP will be recorded to our Google Sheet.</p>
          </form>

          <!-- After submit: show this, hide the form -->
          <div class="result" id="resultBox">
            <div id="resultText"></div>

            <div class="result-actions" style="display:none;">
  <a class="tiny-ico gold" id="waShare" target="_blank" rel="noopener" title="Share on WhatsApp">üü¢</a>
  <div class="tiny-text">Share this invite on WhatsApp</div>
</div>


          <div class="result" id="errBox" style="display:none; border-color: rgba(251,113,133,.45);">
            ‚ùå Sorry ‚Äî something went wrong. Please try again.
          </div>
        </div>
      </div>

      <!-- EVENT INFO -->
      <div class="card">
        <div class="head">
          <div class="title">Event Details</div>
          <div class="pill">Locations</div>
        </div>

        <div class="info">
          <div class="row">
            <div class="k">Date</div>
            <div class="v">April 06</div>
          </div>

          <div class="row">
            <div class="k">Church</div>
            <div class="v">
              Saint Michael's Catholic Church<br/>
              129 High St, Berwick VIC 3806<br/>
              <a class="mapbtn" target="_blank"
                 href="https://www.google.com/maps/search/?api=1&query=Saint%20Michael%27s%20Catholic%20Church%2C%20129%20High%20St%2C%20Berwick%20VIC%203806">
                Open Church in Google Maps
              </a>
            </div>
          </div>

          <div class="row">
            <div class="k">Reception</div>
            <div class="v">
              Golden Castle Function Centre<br/>
              Hampton Park, Victoria<br/>
              <a class="mapbtn" target="_blank"
                 href="https://www.google.com/maps/search/?api=1&query=Golden%20Castle%20Function%20Centre%2C%20Hampton%20Park%2C%20Victoria">
                Open Reception in Google Maps
              </a>
            </div>
          </div>

          <!-- Times + small add-to-calendar icons -->
          <div class="row">
            <div class="k">Times</div>
            <div class="v" style="width:100%">
              <div class="times-wrap">
                <div class="time-line">
                  <div class="time-left">
                    <div class="time-title">Holy Mass</div>
                    <div class="time-when"><b>3:00 PM</b></div>
                  </div>
                  <div class="cal-icons" aria-label="Add Holy Mass to calendar">
                    <a class="cal-ico gold" id="gcalMass" target="_blank" rel="noopener" title="Add to Google Calendar">G</a>
                    <button class="cal-ico" id="icsMass" type="button" title="Add to Apple Calendar (.ics)">Ô£ø</button>
                  </div>
                </div>

                <div class="time-line">
                  <div class="time-left">
                    <div class="time-title">Reception</div>
                    <div class="time-when"><b>6:30 PM</b></div>
                  </div>
                  <div class="cal-icons" aria-label="Add Reception to calendar">
                    <a class="cal-ico gold" id="gcalReception" target="_blank" rel="noopener" title="Add to Google Calendar">G</a>
                    <button class="cal-ico" id="icsReception" type="button" title="Add to Apple Calendar (.ics)">Ô£ø</button>
                  </div>
                </div>
              </div>

              <div class="cal-help">Tap <b>G</b> for Google Calendar, or <b>Ô£ø</b> to download an Apple Calendar file.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>Tip: share this RSVP page link on WhatsApp / SMS / email.</footer>
  </div>

  <script>
    // =======================
    // RSVP -> Google Form POST
    // =======================
    const FORM_ACTION =
      "https://docs.google.com/forms/d/e/1FAIpQLSf26EDBCCSbnyzG39YNCY3YQ8btg2r1uUcti29MCU94SLxaJA/formResponse";

    const ENTRY_MAP = {
      familyName: "entry.169108837",
      attending:  "entry.1331553265",
      adults:     "entry.944248803",
      kids:       "entry.1620308496"
    };

    const form = document.getElementById("rsvpForm");
    const resetBtn = document.getElementById("resetBtn");
    const submitBtn = document.getElementById("submitBtn");

    const attendingSelect = document.getElementById("attending");
    const adultsInput = document.getElementById("adults");
    const kidsInput = document.getElementById("kids");

    const resultBox = document.getElementById("resultBox");
    const errBox = document.getElementById("errBox");
    const resultText = document.getElementById("resultText");
    const waShare = document.getElementById("waShare");

    function show(el){ el.style.display = "block"; }
    function hide(el){ el.style.display = "none"; }

    function updateAttendanceRules() {
      const attending = attendingSelect.value;

      if (attending === "Yes") {
        adultsInput.disabled = false;
        kidsInput.disabled = false;

        adultsInput.min = 1;
        adultsInput.required = true;

        if (parseInt(adultsInput.value || "0", 10) < 1) adultsInput.value = 1;

      } else if (attending === "No") {
        adultsInput.value = 0;
        kidsInput.value = 0;

        adultsInput.disabled = true;
        kidsInput.disabled = true;

        adultsInput.required = false;
        adultsInput.min = 0;

      } else {
        adultsInput.disabled = false;
        kidsInput.disabled = false;
        adultsInput.min = 0;
        adultsInput.required = true;
      }
    }

    attendingSelect.addEventListener("change", updateAttendanceRules);
    updateAttendanceRules();

    resetBtn.addEventListener("click", () => {
      form.reset();
      hide(resultBox);
      hide(errBox);
      form.style.display = "grid";
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit RSVP";
      updateAttendanceRules();
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(resultBox);
      hide(errBox);

      // Enforce rule: If attending Yes, adults must be >= 1
      if (attendingSelect.value === "Yes" && parseInt(adultsInput.value || "0", 10) < 1) {
        adultsInput.focus();
        adultsInput.setCustomValidity("Please enter at least 1 adult.");
        adultsInput.reportValidity();
        adultsInput.setCustomValidity("");
        return;
      }

      // If attending No, ensure 0s are sent
      if (attendingSelect.value === "No") {
        adultsInput.value = 0;
        kidsInput.value = 0;
      }

      const data = Object.fromEntries(new FormData(form).entries());

      // Build a human-friendly message first (so even if submission fails, you can show error)
      const attending = data.attending;
      const adults = parseInt(data.adults || "0", 10);
      const kids = parseInt(data.kids || "0", 10);
      const who = (data.familyName || "").trim();

      let summary = "";
      if (attending === "No") {
        summary = `Thanks${who ? " " + who : ""}! We‚Äôve received your RSVP ‚Äî <strong>not attending</strong>.`;
      } else {
        summary = `Thanks${who ? " " + who : ""}! RSVP received for <strong>${adults} Adult${adults===1?"":"s"}</strong> and <strong>${kids} Kid${kids===1?"":"s"}</strong>.`;
      }

      // WhatsApp share link
      const pageUrl = window.location.href.split("#")[0];
      const shareMsg =
        `Tiara Liz Thomas ‚Äî First Holy Communion\n` +
        `Date: April 06\nHoly Mass: 3:00 PM\nReception: 6:30 PM\n\n` +
        `RSVP here: ${pageUrl}`;
      waShare.href = `https://wa.me/?text=${encodeURIComponent(shareMsg)}`;

      // Prepare google form submission
      const fd = new FormData();
      for (const [name, entryId] of Object.entries(ENTRY_MAP)) {
        fd.append(entryId, data[name] ?? "");
      }

      // UI: disable submit to prevent double clicks
      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting‚Ä¶";

      try {
        await fetch(FORM_ACTION, { method: "POST", mode: "no-cors", body: fd });

        // Hide the form and show the summary
        form.style.display = "none";
        resultText.innerHTML = `‚úÖ ${summary}`;
        show(resultBox);

      } catch (err) {
        show(errBox);
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit RSVP";
      }
    });

    // =======================
    // Add to Calendar (Google + Apple/ICS)
    // =======================
    const EVENT_YEAR = 2026;
    const EVENT_TZ = "Australia/Melbourne";

    const MASS = {
      title: "Holy Mass ‚Äî Tiara Liz Thomas First Holy Communion",
      location: "Saint Michael's Catholic Church, 129 High St, Berwick VIC 3806",
      description: "First Holy Communion of Tiara Liz Thomas.",
      start: { y: EVENT_YEAR, m: 4, d: 6, hh: 15, mm: 0 },
      end:   { y: EVENT_YEAR, m: 4, d: 6, hh: 16, mm: 0 }
    };

    const RECEPTION = {
      title: "Reception ‚Äî Tiara Liz Thomas First Holy Communion",
      location: "Golden Castle Function Centre, Hampton Park, Victoria",
      description: "Reception for Tiara Liz Thomas First Holy Communion.",
      start: { y: EVENT_YEAR, m: 4, d: 6, hh: 18, mm: 30 },
      end:   { y: EVENT_YEAR, m: 4, d: 6, hh: 22, mm: 30 }
    };

    function toUtcIcs(dt) {
      const local = new Date(dt.y, dt.m - 1, dt.d, dt.hh, dt.mm, 0);
      const yyyy = local.getUTCFullYear();
      const MM = String(local.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(local.getUTCDate()).padStart(2, "0");
      const HH = String(local.getUTCHours()).padStart(2, "0");
      const mm = String(local.getUTCMinutes()).padStart(2, "0");
      return `${yyyy}${MM}${dd}T${HH}${mm}00Z`;
    }

    function googleDateRange(start, end) {
      return `${toUtcIcs(start)}/${toUtcIcs(end)}`;
    }

    function buildGoogleUrl(ev) {
      const params = new URLSearchParams({
        action: "TEMPLATE",
        text: ev.title,
        dates: googleDateRange(ev.start, ev.end),
        details: ev.description,
        location: ev.location,
        ctz: EVENT_TZ
      });
      return `https://calendar.google.com/calendar/render?${params.toString()}`;
    }

    function escapeIcsText(s) {
      return String(s || "")
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function buildIcs(ev) {
      const uid = `tiara-communion-${Math.random().toString(16).slice(2)}@githubpages`;
      const now = new Date();
      const dtstamp =
        `${now.getUTCFullYear()}${String(now.getUTCMonth()+1).padStart(2,"0")}${String(now.getUTCDate()).padStart(2,"0")}` +
        `T${String(now.getUTCHours()).padStart(2,"0")}${String(now.getUTCMinutes()).padStart(2,"0")}00Z`;

      return [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Tiara Holy Communion//RSVP//EN",
        "CALSCALE:GREGORIAN",
        "METHOD:PUBLISH",
        "BEGIN:VEVENT",
        `UID:${uid}`,
        `DTSTAMP:${dtstamp}`,
        `DTSTART:${toUtcIcs(ev.start)}`,
        `DTEND:${toUtcIcs(ev.end)}`,
        `SUMMARY:${escapeIcsText(ev.title)}`,
        `DESCRIPTION:${escapeIcsText(ev.description)}`,
        `LOCATION:${escapeIcsText(ev.location)}`,
        "END:VEVENT",
        "END:VCALENDAR"
      ].join("\r\n");
    }

    function downloadIcs(ev, filename) {
      const ics = buildIcs(ev);
      const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    // Wire up calendar icon links
    const gcalMass = document.getElementById("gcalMass");
    const gcalReception = document.getElementById("gcalReception");
    const icsMass = document.getElementById("icsMass");
    const icsReception = document.getElementById("icsReception");

    gcalMass.href = buildGoogleUrl(MASS);
    gcalReception.href = buildGoogleUrl(RECEPTION);

    icsMass.addEventListener("click", () => downloadIcs(MASS, "Tiara-Holy-Mass.ics"));
    icsReception.addEventListener("click", () => downloadIcs(RECEPTION, "Tiara-Reception.ics"));
  </script>
</body>
</html>
